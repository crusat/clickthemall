<!DOCTYPE html>
<html>
<head>
    <title>Click Them All</title>
    <style>
        #src {
            width: 500px;
            height: 500px;
        }
        .ball {
            border-radius: 25px;
            width: 25px;
            height: 25px;
            float: left;
            display: block;
        }
        .green {
            background: green;
        }
        .red {
            background: #c41e3a;
        }
        .yellow {
            background: #daa520;
        }
        .blue {
            background: #08457e;
        }
        .white {
            background: white;
        }
    </style>
    <script src="jquery-1.8.1.min.js"></script>
</head>
<body>
    <div id="src"></div>
<script>

    // Генерация игрового массива
    function createArray(max_width, max_height, min_value, max_value) {
        var arr = [];
        for (var x = 0; x < max_width; x++) {
            arr.push([]);
            for (var y = 0; y < max_height; y++) {
                arr[x].push(Math.floor(min_value + Math.random()*(max_value-min_value+1)));
            }
        }
        return arr;
    }

    // Отображение игрового поля в табличном виде
    function renderTable(arr) {
        var html = '<table border="1">';
        for (var y = 0; y < arr.length; y++) {
            html += '<tr>';
            for (var x = 0; x < arr[y].length; x++) {
                html += '<td>' + arr[y][x] + '</td>';
            }
            html += '</tr>';
        }
        html += '</table>';
        return html;
    }

    // Отображение игрового поля в красивом виде
    function render(gf, colors) {
        var divfield = '';
        for (var i=0; i < gf.length; i++) {
            for (var j=0; j < gf[i].length; j++) {
                divfield += '<div data-x="'+j+'" data-y="'+i+'" class="ball ' + colors[gf[i][j]] + '"></div>';
            }
        }
        return divfield;
    }

    // Падение блоков сверху вниз, если в столбце есть пустые (равные нулю) блоки и слева направо, если столбец слева целиком пустой (только нули)
    function falling(arr) {
        // Переменная, которая показывает номер самого левого столбца с нулями
        var leftColumn = 0;
        // Перебираем все столбцы слева направо
        for(var x = 0; x < arr.length; x++) {
            // Записываем номер самой нижней строки
            var topRow = arr[0].length - 1;
            // Перебираем все строки снизу вверх
            for(var y = arr[0].length-1; y >= 0; y--) {
                // Если элемент со строкой Y и столбцом X не равен 0, то
                if(arr[y][x] !== 0) {
                    // Если строка поиска (topRow) находится ниже (ее индекс больше) строки Y
                    if(topRow > y) {
                        // Ставим на строку topRow найденное ненулевое значение
                        arr[topRow][leftColumn] = arr[y][x];
                        // А выше ставим ноль
                        arr[y][x] = 0;
                    } else if (leftColumn != x) {
                        arr[y][leftColumn] = arr[y][x];
                        arr[y][x] = 0;
                    }
                    // Поднимаем строку поиска нулей на одну позицию выше
                    topRow--;
                }
            }
            // Если самая нижняя строка столбца leftColumn равна нулю, то мы должны записать следующую строку в него
            if(arr[arr[0].length-1][leftColumn] !== 0) {
                // Иначе переходим к следующему столбцу
                leftColumn++;
            }
        }
        return arr;
    }

    // удаление с игрового поля блоков одинакового цвета
    function deleteFromGF(gf, x,y, col) {
        y = parseInt(y);
        x = parseInt(x);
        var testX, testY;
        gf[y][x] = 0;
        var yArr, xArr;
        if ((y > 0)&&(y<19)) {
            yArr = [y-1, y, y+1];
        }
        if (y == 0) {
            yArr = [y, y+1];
        }
        if (y == 19) {
            yArr = [y-1, y];
        }

        if ((x > 0)&&(x<19)) {
            xArr = [x-1, x, x+1];
        }
        if (x == 0) {
            xArr = [x, x+1];
        }
        if (x == 19) {
            xArr = [x-1, x];
        }

        var xx, yy;
        for (testY in yArr) {
            for (testX in xArr) {
                xx = xArr[testX];
                yy = yArr[testY];
                if ((xx == x)||(yy == y)) {
                    if (col == gf[yy][xx]) {
                        gf = deleteFromGF(gf,xx,yy, col);
                    }
                }

            }
        }
        return gf;
    }

    // Привязываем события ко всем элементам
    $('.ball').live('click', function() {
        var $this = $(this);
        if (!$this.hasClass('white')) {
            var x = $this.attr('data-x');
            var y = $this.attr('data-y');
            var col = gameField[y][x];
            gameField = deleteFromGF(gameField, x, y, col);
            gameField = falling(gameField);
            console.log(gameField);
            document.getElementById('src').innerHTML = render(gameField, colors);
        }
    });


    var gameField = [];
    var gamefield_width = 20;
    var gamefield_height = 20;
    var colors = ['white', 'green', 'red', 'yellow', 'blue'];
    gameField = createArray(gamefield_width, gamefield_height, 1, 4);
    document.getElementById('src').innerHTML = render(gameField, colors);
</script>
</body>
</html>